{% extends "admin/base_site.html" %}
{% load i18n %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='authentication' %}">Authentication</a>
    &rsaquo; Active Sessions
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
    <form method="get" style="display: flex; align-items: center; gap: 10px;">
        <label for="user-filter" style="font-weight: 500;">Filter by user:</label>
        <select name="user" id="user-filter" style="padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; min-width: 250px;">
            <option value="">All users</option>
            {% for user in all_users %}
            <option value="{{ user.id }}" {% if user_filter == user.id|stringformat:"s" %}selected{% endif %}>
                {{ user.email }}
            </option>
            {% endfor %}
        </select>
        <button type="submit" style="padding: 8px 16px; background: #4874e4; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Filter
        </button>
        {% if user_filter %}
        <a href="{% url 'admin:auth_sessions' %}" style="padding: 8px 16px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">
            Clear
        </a>
        {% endif %}
    </form>
</div>

<p style="margin-bottom: 20px; color: #666;">
    These sessions are stored in Redis and represent active refresh tokens.
    <strong>Total: {{ sessions|length }}</strong>
</p>

{% if messages %}
<ul class="messagelist">
    {% for message in messages %}
    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}

{% if sessions %}
<div class="results">
<table id="result_list">
    <thead>
        <tr>
            <th scope="col"><div class="text">User</div></th>
            <th scope="col"><div class="text">IP Address</div></th>
            <th scope="col"><div class="text">User Agent</div></th>
            <th scope="col"><div class="text">Created</div></th>
            <th scope="col"><div class="text">Last Used</div></th>
            <th scope="col"><div class="text">Session ID</div></th>
            <th scope="col"><div class="text">Actions</div></th>
        </tr>
    </thead>
    <tbody>
        {% for session in sessions %}
        <tr class="{% cycle 'row1' 'row2' %}">
            <td>{{ session.user_email }}</td>
            <td>{{ session.ip }}</td>
            <td title="{{ session.user_agent }}">{{ session.user_agent|truncatechars:40 }}</td>
            <td>{{ session.created_at }}</td>
            <td>{{ session.last_used_at }}</td>
            <td style="font-family: monospace; font-size: 11px;">{{ session.jti|truncatechars:16 }}...</td>
            <td>
                <a href="{% url 'admin:auth_session_revoke' session.jti %}" 
                   onclick="return confirm('Are you sure you want to revoke this session?');"
                   style="padding: 4px 10px; background: #dc3545; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                    Revoke
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% else %}
<p class="paginator">No active sessions found.</p>
{% endif %}

{% endblock %}
